// ==UserScript==
// @name         Faction Bank AutoFill (Dropdown Fix)
// @namespace    http://tampermonkey.net/
// @version      1.2.4
// @description  Auto-fills Torn faction bank form reliably with dropdown opening
// @match        https://www.torn.com/factions.php*
// @grant        none
// @license      MIT
// ==/UserScript==

(async function () {
    'use strict';

    const log = (...args) => console.log('[AutoFill]', ...args);
    const sleep = ms => new Promise(res => setTimeout(res, ms));
    const targetName = "OgBob";

    async function waitForElement(selectors, tries = 40, delay = 300) {
        for (let i = 0; i < tries; i++) {
            for (const sel of selectors) {
                const el = document.querySelector(sel);
                if (el) return el;
            }
            await sleep(delay);
        }
        return null;
    }

    log("ðŸš€ Autofill starting");

    const nameInput = await waitForElement([
        'input[name="user"]',
        'input[name="searchAccount"]',
        'input.playername',
        'input[class*=userAutocomplete]'
    ]);

    if (!nameInput) return log("âŒ Name input not found");

    // Step 1: Try clicking the dropdown arrow to trigger list load
    const dropdownToggle = nameInput.closest('div')?.querySelector('svg, .icon-down, .dropdown-arrow');
    if (dropdownToggle) {
        dropdownToggle.click();
        log("ðŸ“‚ Clicked dropdown arrow");
        await sleep(300); // Give it time to open
    }

    // Step 2: Fill the name
    nameInput.focus();
    nameInput.value = targetName;
    nameInput.dispatchEvent(new Event("input", { bubbles: true }));
    nameInput.dispatchEvent(new KeyboardEvent("keydown", { key: "Enter", bubbles: true }));

    log("âœ… Name filled");

    await sleep(500);

    // Step 3: Try to find the balance
    const amountInput = await waitForElement([
        'input[class*="input-money"]',
        'input[type="text"].money'
    ]);

    if (!amountInput) return log("âŒ Amount input not found");

    // Search rows containing the user's name and money balance
    let balance = null;
    const rows = [...document.querySelectorAll('div[class*="user-info-row"], tr')];
    for (const row of rows) {
        const text = row.textContent || '';
        if (text.includes(targetName) && text.includes('$')) {
            const match = text.match(/\$([\d,]+)/);
            if (match) {
                balance = match[1].replace(/,/g, '');
                break;
            }
        }
    }

    if (!balance) return log("âŒ Balance not found");

    amountInput.focus();
    amountInput.value = balance;
    amountInput.dispatchEvent(new Event("input", { bubbles: true }));

    log("âœ… Filled balance:", balance);
})();
