// ==UserScript==
// @name         Faction Bank AutoFill (Desktop + PDA)
// @namespace    http://tampermonkey.net/
// @version      1.2.2
// @description  Auto-fills the faction money form for a user with balance checks (works on desktop + PDA)
// @match        https://www.torn.com/factions.php*
// @grant        none
// @license      MIT
// ==/UserScript==

(async function () {
    'use strict';

    const log = (...args) => console.log('[AutoFill]', ...args);
    const sleep = ms => new Promise(res => setTimeout(res, ms));

    async function waitForInput(selectors, tries = 20) {
        for (let i = 0; i < tries; i++) {
            for (const sel of selectors) {
                const el = document.querySelector(sel);
                if (el) return el;
            }
            await sleep(300);
        }
        return null;
    }

    const targetName = "OgBob";
    log("üöÄ Starting with name:", targetName);

    const nameInput = await waitForInput([
        'input[name="user"]',
        'input[name="searchAccount"]',
        'input.playername'
    ]);

    const amountInput = await waitForInput([
        'input[class*="input-money"]',
        'input[type="text"].money' // fallback
    ]);

    if (!nameInput || !amountInput) {
        log("‚ùå Missing inputs");
        return;
    }

    // Find matching text content with balance
    const all = [...document.querySelectorAll("*")];
    const match = all.find(el => el.textContent?.includes(`${targetName}\`s current balance is $`));
    const found = match?.textContent?.match(/\$([\d,]+)/);
    const balance = found?.[1]?.replace(/,/g, '');

    if (!balance) {
        log("‚ùå Could not locate balance");
        return;
    }

    // Fill player name
    nameInput.focus();
    nameInput.value = targetName;
    nameInput.dispatchEvent(new Event("input", { bubbles: true }));
    log("‚úÖ Filled name input");

    // Fill balance
    await sleep(100); // slight delay for PDA input handling
    amountInput.focus();
    amountInput.value = balance;
    amountInput.dispatchEvent(new Event("input", { bubbles: true }));
    log("‚úÖ Filled amount input:", balance);
})();
