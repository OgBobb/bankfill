// ==UserScript==
// @name         Torn PDA Bank Autofill
// @version      1.2.7
// @match        https://www.torn.com/factions.php*
// @grant        none
// ==/UserScript==

(async function () {
    'use strict';

    const wait = (ms) => new Promise((res) => setTimeout(res, ms));

    function log(...args) {
        console.log('[AutoFill]', ...args);
    }

    // â”€â”€â”€ Step 1: Delay start so PDA loads internal page â”€â”€â”€â”€â”€â”€
    log('â³ Waiting for Torn PDA to fully load...');
    await wait(5000); // increase this if it's still too early

    // â”€â”€â”€ Step 2: Extract info from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const hashParams = new URLSearchParams(window.location.hash.split('?')[1]);
    const targetName = hashParams.get('name');
    const targetAmount = hashParams.get('amount');

    if (!targetName || !targetAmount) {
        log('âŒ Missing name or amount in URL');
        return;
    }

    log(`ğŸš€ Autofill starting with name: ${targetName}, amount: ${targetAmount}`);

    // â”€â”€â”€ Step 3: Find input fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const nameInput = document.querySelector('input.userAutocomplete___xqlGt');
    const moneyInput = document.querySelector('input.input-money');

    if (!nameInput || !moneyInput) {
        log('âŒ Could not locate name or amount input');
        return;
    }

    // â”€â”€â”€ Step 4: Type in name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    nameInput.focus();
    nameInput.value = targetName;

    nameInput.dispatchEvent(new Event('input', { bubbles: true }));
    nameInput.dispatchEvent(new Event('change', { bubbles: true }));

    log('âœï¸ Name typed, waiting for dropdown...');
    await wait(1200); // give time for suggestions

    // â”€â”€â”€ Step 5: Select from dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const suggestions = [...document.querySelectorAll('[class*=userAutocompleteItem]')];
    const match = suggestions.find(el => el.textContent.includes(targetName));

    if (match) {
        match.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
        match.click();
        log('âœ… Dropdown name selected');
    } else {
        log('âš ï¸ No dropdown match found');
    }

    await wait(300); // settle

    // â”€â”€â”€ Step 6: Fill in amount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    moneyInput.focus();
    moneyInput.value = targetAmount;

    moneyInput.dispatchEvent(new Event('input', { bubbles: true }));
    moneyInput.dispatchEvent(new Event('change', { bubbles: true }));

    log('ğŸ’° Amount filled in successfully');
})();
